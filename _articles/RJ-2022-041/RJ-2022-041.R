# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2022-041.Rmd to modify this file

## ----setup, include = FALSE---------------------------------------------------
library(knitr)
opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = TRUE,
	cache = FALSE,
	cache.extra = rand_seed
)


## ----sim1---------------------------------------------------------------------
library(fastpos)
set.seed(20200219)
find_critical_pos(rho = 0.6, precision_absolute = 0.1, confidence_levels = .8,
                  sample_size_min = 20, sample_size_max = 1e3, n_studies = 1e4)


## ----sim2---------------------------------------------------------------------
library(simpleCache)
setCacheDir("titz_cache")
simpleCache("sim2", {find_critical_pos(rho = seq(.1, .7, .1), n_studies = 1e5)})
sim2


## ----takesmin, include=FALSE--------------------------------------------------
simpleCache("takesmin", {
  tictoc::tic()
  find_critical_pos(rho = 0.1, sample_size_max = 1e3,
                                           n_studies = 1e6)
  res <- tictoc::toc()
  round((res$toc-res$tic) * 100 / 60)})


## ----sim3---------------------------------------------------------------------
simpleCache("sim3", {find_critical_pos(rho = rep(0.1, 100),
                                       sample_size_max = 1e3, n_studies = 1e6)})


## ----select-------------------------------------------------------------------
sim3 <- sim3[, c("pos.80%", "pos.90%", "pos.95%")]
colMeans(sim3)
round(apply(sim3, 2, sd), 3)


## ----simulatepos--------------------------------------------------------------
pop <- create_pop(rho = 0.1, size = 1e6)
simpleCache("sim4", {simulate_pos(x_pop = pop[, 1], y_pop = pop[, 2],
                                  n_studies = 1e6, sample_size_min = 20,
                                  sample_size_max = 1e3, replace = TRUE,
                                  lower_limit = 0, upper_limit = 0.2,
                                  progress = FALSE)})


## ----quantiles, cache=FALSE---------------------------------------------------
quantile(sim4, c(.8, .9, .95), na.rm = TRUE)
sim4b <- ifelse(is.na(sim4), 1e3, sim4)
quantile(sim4b, c(.8, .9, .95))


## ----summary2-----------------------------------------------------------------
simpleCache("sim5", {find_critical_pos(rho = rep(0.1, 100),
                                       sample_size_max = 5e3,
                                       n_studies = 1e6)})
sim5 <- sim5[, c("pos.80%", "pos.90%", "pos.95%")]
colMeans(sim5)
round(apply(sim5, 2, sd), 3)


## ----correct10k---------------------------------------------------------------
simpleCache("sim6", {find_critical_pos(rho = rep(0.1, 100),
                                       sample_size_max = 1e4, 
                                       n_studies = 1e6)})
sim6 <- sim6[, c("pos.80%", "pos.90%", "pos.95%")]
colMeans(sim6)
round(apply(sim6, 2, sd), 3)


## git -C corEvol pull || git clone --single-branch --branch benchmark \

##   https://github.com/johannes-titz/corEvol


## ----bm, warning=FALSE--------------------------------------------------------
library(microbenchmark)
corevol <- function() {
  setwd("corEvol")
  source("01-simdata.R")
  source("02-analyse.R")
  setwd("../")
}
fastpos <- function() {
  find_critical_pos(rho = .1, sample_size_max = 1e3, n_studies = 1e4,
                    progress = FALSE)
}
simpleCache("bm", {microbenchmark(corevol = corevol(), fastpos = fastpos(),
                                  times = 10, unit = "s")})
summary(bm)

## ----speedup, include=FALSE, cache=FALSE--------------------------------------
speedup <- round(summary(bm)$mean[1] / summary(bm)$mean[2])
corevol <- round(summary(bm)$mean[1])


## ----es-----------------------------------------------------------------------
r <- effectsize::d_to_r(0.5)
lower_limit <- effectsize::d_to_r(0.4)
upper_limit <- effectsize::d_to_r(0.6)
simpleCache("sim7", {find_critical_pos(rho = r, sample_size_max = 11e3,
                                       n_studies = 1e5,
                                       lower_limit = lower_limit,
                                       upper_limit = upper_limit)})
sim7

