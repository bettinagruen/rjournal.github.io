# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2023-038.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)


## ----import-and-load, echo = TRUE---------------------------------------------
library("BayesCACE")
data("epidural_c", package = "BayesCACE")
epidural_c


## ----load-more-data, echo = TRUE----------------------------------------------
data("epidural_ic", package = "BayesCACE")
head(epidural_ic)


## ----plt-noncomp, echo = TRUE, eval = FALSE-----------------------------------
#> plt.noncomp(data, overall = TRUE)


## ----noncomp, out.width = "100%", out.height = "27%", fig.align="center", fig.cap = "Noncompliance rates plot generated by the function plt.noncomp(). The red dots and lines show the study-specific noncompliance rate with its 95\\% confidence interval randomized to the treatment arm, and the blue squares and lines refer to those in the control arm."----
knitr::include_graphics("noncomp.png")


## ----cace-study-args, echo = TRUE, eval = FALSE-------------------------------
#> cace.study(data, param = c("CACE", "u1", "v1", "s1", "b1", "pi.c", "pi.n",
#>   "pi.a"), re.values = list(), model.code = '', digits = 3, n.adapt = 1000,
#>   n.iter = 100000, n.burnin = floor(n.iter/2), n.chains = 3, n.thin =
#>   max(1,floor((n.iter-n.burnin)/1e+05)), conv.diag = FALSE, mcmc.samples =
#>   FALSE, two.step = FALSE, method = "REML")


## ----show-out-string, echo = T, results = 'hide'------------------------------
  out.string <-   
    "# priors
    n ~ dnorm(0, 0.01)
    a ~ dnorm(0, 0.01)
    alpha.s ~ dnorm(0, 0.01)
    alpha.b ~ dnorm(0, 0.01)
    alpha.u ~ dnorm(0, 0.01)
    alpha.v ~ dnorm(0, 0.01)
    "


## ----run-cace-study, echo = T, results = 'hide'-------------------------------
data("epidural_c", package = "BayesCACE")
set.seed(123)
out.study <- cace.study(data = epidural_c, conv.diag = TRUE, 
                        mcmc.samples = TRUE, two.step = TRUE)


## ----show-cace-study-output, eval=FALSE, echo=TRUE----------------------------
#> % NA is not allowed in the input data set;
#> % the rows containing NA are removed.
#> Compiling model graph
#>    Resolving undeclared variables
#>    Allocating nodes
#> Graph information:
#>    Observed stochastic nodes: 2
#>    Unobserved stochastic nodes: 6
#>    Total graph size: 44
#> 
#> Initializing model
#> 
#>   |++++++++++++++++++++++++++++++++++++++++++++++++++| 100%
#>   |**************************************************| 100%
#>   |**************************************************| 100%
#> MCMC convergence diagnostic statistics are calculated and saved in conv.out


## ----show-out-study-cace, echo = T--------------------------------------------
out.study$CACE


## ----show-out-study-conv, echo = T--------------------------------------------
out.study$conv.out[[1]]


## ----show-out-study-meta, echo = T--------------------------------------------
out.study$meta


## ----cace-meta-c-args, eval = FALSE, echo = TRUE------------------------------
#> cace.meta.c(data, param = c("CACE", "u1out", "v1out", "s1out", "b1out",
#>   "pic", "pin", "pia"), random.effects = list(), re.values = list(),
#>   model.code = '', digits = 3, n.adapt = 1000, n.iter = 100000,
#>   n.burnin = floor(n.iter/2), n.chains = 3, n.thin =
#>   max(1,floor((n.iter-n.burnin)/100000)), conv.diag = FALSE,
#>   mcmc.samples = FALSE, study.specific = FALSE)


## ----show-cace-meta-c-string, echo = T, results = 'hide'----------------------
string <-   
"# priors
alpha.n ~  dnorm(0, 0.16)
alpha.a ~ dnorm(0, 0.16)    
alpha.s ~  dnorm(0, 0.25)
alpha.b ~  dnorm(0, 0.25)
alpha.u ~  dnorm(0, 0.25)
alpha.v ~  dnorm(0, 0.25) 

II[1,1] <- 1
II[2,2] <- 1
II[1,2] <- 0
II[2,1] <- 0

Omega.rho ~  dwish (II[,], 3)
Sigma.rho <- inverse(Omega.rho)
sigma.n <- Sigma.rho[1, 1]
sigma.a <- Sigma.rho[2, 2]
rho <- Sigma.rho[1, 2]
u1out <- phi(alpha.u/sqrt(1+sigma.u^2))
tau.u ~ dgamma(2, 2)
sigma.u <- 1/sqrt(tau.u)
v1out <- phi(alpha.v)
CACE <- u1out-v1out
s1out <- ilogit(alpha.s/sqrt(1 + (16^2*3/(15^2*pi^2))*sigma.s^2))
tau.s ~ dgamma(2, 2)
sigma.s <- 1/sqrt(tau.s)
b1out <- ilogit(alpha.b/sqrt(1 + (16^2*3/(15^2*pi^2))*sigma.b^2))
tau.b ~ dgamma(2, 2)
sigma.b <- 1/sqrt(tau.b)
"


## ----run-cace-meta-c, echo = T, results = 'hide'------------------------------
data("epidural_c", package = "BayesCACE")
set.seed(123)
out.meta.c <- cace.meta.c(data = epidural_c, conv.diag = TRUE, 
                          mcmc.samples = TRUE, study.specific = TRUE)


## ----out-meta-c-smry, echo = T------------------------------------------------
out.meta.c$smry


## ----out-meta-c-dic, echo = T-------------------------------------------------
out.meta.c$DIC


## ----cace-meta-ic-args, echo = TRUE, eval = FALSE-----------------------------
#> cace.meta.ic(data, param = c("CACE", "u1out", "v1out", "s1out", "b1out",
#>   "pic", "pin", "pia"), random.effects = list(), re.values = list(),
#>   model.code = '', digits = 3, n.adapt = 1000, n.iter = 100000,
#>   n.burnin = floor(n.iter/2), n.chains = 3, n.thin =
#>   max(1,floor((n.iter-n.burnin)/100000)), conv.diag = FALSE,
#>   mcmc.samples = FALSE, study.specific = FALSE)


## ----run-cace-meta-ic, echo = T, results = 'hide'-----------------------------
data("epidural_ic", package = "BayesCACE")
set.seed(123)
out.meta.ic <- cace.meta.ic(data = epidural_ic, conv.diag = TRUE, 
                            mcmc.samples = TRUE, study.specific = TRUE)


## ----plt-trace-den-acf-args, echo = TRUE, eval = FALSE------------------------
#> plt.trace(obj, param = c("CACE"), trialnumber = 1, ...)
#> plt.density(obj, param = c("CACE"), trialnumber = 1, ...)
#> plt.acf(obj, param = c("CACE"), trialnumber = 1, ...)


## ----plt-trace-den-acf, echo = TRUE, eval = FALSE-----------------------------
#> plt.trace(obj = out.meta.ic)
#> plt.density(obj = out.meta.ic)
#> plt.acf(obj = out.meta.ic)


## ----trace, out.width = "95%", out.height = "50%", fig.align='center', fig.cap = "Trace plots for $\\theta^\\text{CACE}$ from the epidural\\_ic dataset fit using cace.meta.ic() for a sample of 3 chains. Because there are no strong patterns and the variability is relatively constant, we can conclude that the posterior means are drawn from a stationary distribution."----
knitr::include_graphics("trace_sep.png")


## ----density, out.width = "90%", out.height = "40%", fig.align='center', fig.cap = "The kernel smoothed density for $\\theta^{\\text{CACE}}$ from the function cace.meta.ic() applied to the epidural analgesia in labor meta-analysis. The posterior mean is close to 0, indicating that the complier average causal effect may not be significant in this case."----
knitr::include_graphics("posdens.png")


## ----autocorr, out.width = "90%", out.height = "40%", fig.align='center', fig.cap = "Auto-correlation plot of $\\theta^{\\text{CACE}}$ from the model cace.meta.ic() fit to the epidural\\_ic dataset. As the lag increases, the values become less correlated. Users can choose to address high auto-correlation with a longer chain or a larger n.thin."----
knitr::include_graphics("autocor.png")


## ----plt-forest, echo = TRUE, eval = FALSE------------------------------------
#> plt.forest(data = epidural_ic, obj = out.meta.ic)


## ----forest, out.width = "100%", out.height = "55%", fig.align="center", fig.cap = "Forest plot of study-specific $\\theta^{\\text{CACE}}$ from the model cace.meta.ic() with full random effects fit to the epidural\\_ic dataset. The summary estimate and confidence interval limits based on the model cace.meta.ic() are included in the figure, both in terms of written values and the squares and lines on the right. Overall, it shows that the study-specific $\\theta^{\\text{CACE}}_i$ vary from negative to positive in individual studies, while most of the 95\\% credible intervals cover zero."----
knitr::include_graphics("forest_ic.png")

