# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2022-057.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(metadynminer)
library(metadynminer3d)


## ----Metadynamics, out.width = "80%", fig.align="center", fig.cap = "Metadynamics simulation of alanine dipeptide. Dihedral angle $\\phi$ was used as the collective variable. The top part shows molecular structures of three free energy minima (stable structures) differing in the value of $\\phi$. According to metadynamics prediction, A is the global minimum (free energy 0 kJ/mol) and B and C are local minima (1.5 and 6.3 kJ/mol, respectively). According to Equation 1, this corresponds to probabilities 0.61, 0.34, and 0.05 for A, B, and C, respectively. The middle part shows the bias potential (scaled by $(T+\\Delta T)/\\Delta T$) after addition of 1, 10, 100, 200, 500, and 700 hills (colors from red to blue). The bottom part shows the accurate free energy surface calculated by metadynamics with 30,000 hills (black) flooded by 1, 10, 100, 200, 500, and 700 hills (colors from red to blue). The figure was generated by metadynminer except for molecular structures and final assembly."----
knitr::include_graphics("fig1.png")


## ----plothills, out.width = "80%", fig.align="center", fig.dim = c(6, 6), fig.cap = "Scatter plot of hills position. Each point in the plot represents a single hill in the space of collective variable coordinates. This helps to assess which states of the system were sampled."----
  hillsfile <- acealanme
  plot(hillsfile, xlab="phi", ylab="psi", pch=19, cex=0.5, col=gray(0, 0.1))


## ----plotheights, out.width = "80%", fig.align="center", fig.dim = c(6, 6), fig.cap = "Evolution of heights of hills in metadynamics plotted by function plotheights. In well-tempered metadynamics, heights of hills decrease with the progress of flooding of free energy minima. The evolution of heights of hills may help to assess the completeness of flooding."----
  plotheights(hillsfile)


## ----plotfes, out.width = "80%", fig.align="center", fig.dim = c(6, 6), fig.cap = "Free energy surface. Minima (blue colors) represent stable states with high abundance, whereas regions with high free energy correspond to low abundance states."----
  fesurface <- fes(hillsfile)
  plot(fesurface, xlab="phi", ylab="psi")


## -----------------------------------------------------------------------------
  minima <- fesminima(fesurface)
  summary(minima)


## ----minima, out.width = "80%", fig.align="center", fig.dim = c(6, 6), fig.cap = "Free energy surface with indicated free energy minima A-E. The minimum A is the most abundant state, minima B-E are metastable states."----
  minima <- fesminima(fesurface)
  plot(minima)


## ----conv, out.width = "80%", fig.align="center", fig.dim = c(6, 6), fig.cap = "Evolution of free energy differences. The free energy differences of minima B-E (relative to the global minimum A) converge to the exact free energy differences with the progress of the simulation. This plot helps to assess the accuracy of the predicted free energy differences."----
  prof <- feprof(minima)
  plot(prof)


## ----neb, out.width = "80%", fig.align="center", fig.dim = c(6, 6), fig.cap = "Path of transition from A to D projected onto free energy surface. This represents the most favorable path between these minima. It can be used to identify the transition state (the point with the highest energy on the path) and the rate of the transition."----
  nebAD <- neb(minima, min1="A", min2="D")
  plot(minima, xlab="phi", ylab="psi")
  linesonfes(nebAD, lwd=4)


## ----fes3d, out.width = "80%", fig.align="center", fig.cap = "3D free energy surface depicted as isosurface at -30 kJ/mol. It is analogous to the 2D plot in Figure 4, but with three collective variables."----
knitr::include_graphics("fig8.png")


## ----rew, results="hide", out.width = "80%", fig.align="center", fig.dim = c(6, 6), fig.cap = "Free energy surface calculated by reweighting by Tiwary and Parrinello. This free energy surface was calculated by combining the information on time spent in different regions of the free energy surface and on the potential disfavoring these regions. This approach is in general more accurate than the summation of hills used to generate Figures 4-8."----
bf <- 15
kT <- 8.314*300/1000
npoints <- 50
maxfes <- 75
outfes <- 0*fes(hillsfile, npoints=npoints)
step <- 1:50*length(hillsfile$time)/50
s1 <- sapply(step, FUN=function(x) {
          sum(exp(-fes(hillsfile, imax=x)$fes/kT))
})
s2 <- sapply(step, FUN=function(x) {
          sum(exp(-fes(hillsfile, imax=x)$fes/kT/bf))
})
ebetac <- s1/s2
cvs <- read.table("COLVAR.txt")
nsamples <- nrow(cvs)
xlim <- c(-pi,pi)
ylim <- c(-pi,pi)
step <- (1:nsamples-1)*50/nsamples+1
ix <- npoints*(cvs[,2]-xlim[1])/(xlim[2]-xlim[1])+1
iy <- npoints*(cvs[,3]-ylim[1])/(ylim[2]-ylim[1])+1
for(i in 1:nsamples) {
  outfes$fes[ix[i],iy[i]] <- outfes$fes[ix[i],iy[i]] + exp(cvs[i,4]/kT)/
ebetac[step[i]]
}
outfes$fes <- -kT*log(outfes$fes)
outfes <- outfes - min(outfes)
outfes$fes[outfes$fes>maxfes] <- maxfes
plot(outfes, xlab="phi", ylab="psi")

