# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2022-048.Rmd to modify this file

## ----setup, include = F-------------------------------------------------------
library(did2s)
library(ggplot2)
par(family = "HersheySans") # Nicer fonts for base R plots


## -----------------------------------------------------------------------------
#> did2s(data, yname, first_stage, second_stage,
#>       treatment, cluster_var, weights = NULL,
#>       bootstrap = FALSE, n_bootstraps = 250,
#>       verbose = TRUE)


## ---- results = 'hide'--------------------------------------------------------
data(df_het, package = "did2s")


## ----ex-data------------------------------------------------------------------
# Mean for treatment group-year
agg <- aggregate(df_het$dep_var, by=list(g = df_het$g, year = df_het$year), FUN = mean)

agg$g <- as.character(agg$g)
agg$g <- ifelse(agg$g == "0", "Never Treated", agg$g)

never <- agg[agg$g == "Never Treated", ]
g1 <- agg[agg$g == "2000", ]
g2 <- agg[agg$g == "2010", ]


plot(0, 0, xlim = c(1990,2020), ylim = c(2, 8), type = "n",
     main = "Data-generating Process", ylab = "Outcome", xlab = "Year")
lines(never$year, never$x, col = "#8e549f", type = "b", pch = 15)
lines(g1$year, g1$x, col = "#497eb3", type = "b", pch = 17)
lines(g2$year, g2$x, col = "#d2382c", type = "b", pch = 16)
legend(x = 1990, y = 8, col = c("#8e549f", "#497eb3", "#d2382c"), 
       pch = c(15, 17, 16),
       legend = c("Not Treated", "2000", "2010"))




## ----static-------------------------------------------------------------------
static = did2s(
	data = df_het, 
	yname = "dep_var", 
	treatment = "treat",
    first_stage = ~ 0 | unit + year, 
    second_stage = ~ i(treat, ref = FALSE),
    cluster_var = "unit", 
	verbose = FALSE
)

summary(static)


## ----static-output-html-------------------------------------------------------
fixest::etable(static, fitstat = c("n"),
  title = "Estimate of Static TWFE Model", 
  notes = "This table presents the estimated overall treatment effect. The effect is estimated using Two-Stage Difference-in-Differences proposed by Gardner (2021). The estimated effect is close to the true value.")


## ----static-output-tex--------------------------------------------------------
fixest::etable(static, fitstat = c("n"), tex = TRUE,
  title = "Estimate of Static TWFE Model", 
  notes = "This table presents the estimated overall treatment effect. The effect is estimated using Two-Stage Difference-in-Differences proposed by Gardner (2021). The estimated effect is close to the true value.")


## ----dynamic------------------------------------------------------------------
es = did2s(
	data = df_het, 
	yname = "dep_var", 
	treatment = "treat",
	first_stage = ~ 0 | unit + year, 
    second_stage = ~ i(rel_year, ref = c(-1, Inf)),
    cluster_var = "unit", 
	verbose = FALSE
)

fixest::iplot(
	es, 
	main = "Event study: Staggered treatment", 
	xlab = "Relative time to treatment", 
	col = "steelblue", ref.line = -0.5
)

# Add the (mean) true effects
true_effects = tapply((df_het$te + df_het$te_dynamic), df_het$rel_year, mean)
true_effects = head(true_effects, -1)
points(-20:20, true_effects, pch = 20, col = "grey60")

# Legend
legend(x=-20, y=3, col = c("steelblue", "grey60"), 
       pch = c(20, 20), 
       legend = c("Two-stage estimate", "True effect"))


## ----dynamic-w-twfe-----------------------------------------------------------
twfe = feols(dep_var ~ i(rel_year, ref=c(-1, Inf)) | unit + year, data = df_het) 

fixest::iplot(list(es, twfe), sep = 0.2, ref.line = -0.5,
      col = c("steelblue", "#82b446"), pt.pch = c(20, 18), 
      xlab = "Relative time to treatment", 
      main = "Event study: Staggered treatment (comparison)")

# True Effects
points(-20:20, true_effects, pch = 20, col = "grey60")

# Legend
legend(x=-20, y=3, col = c("steelblue", "#82b446", "grey60"), pch = c(20, 18, 20), 
       legend = c("Two-stage estimate", "TWFE", "True Effect"))


## -----------------------------------------------------------------------------
#> event_study(
#> 	data, yname, idname, tname, gname,
#> 	estimator,
#> 	xformla = NULL, horizon = NULL, weights = NULL
#> )


## ----estimators-html----------------------------------------------------------
methods <- tibble::tribble(
  ~`Estimator and R package`, ~Type, ~`Comparison group`, ~`Main Assumptions`,
  "Gardner (2021) <br /> <code>{did2s}</code>", "Imputes \\(Y(0)\\)", "Not-yet- and/or Never-treated", "<ul><li>Parallel Trends for all units</li><li>Limited anticipation<sup>*</sup></li><li>Correct specification of \\(Y(0)\\)</li></ul>",
  "Borusyak, Jaravel, and Spiess (2021) <br /> <code>{didimputation}</code>", "Imputes \\(Y(0)\\)", "Not-yet- and/or Never-treated", "<ul><li>Parallel Trends for all units</li><li>Limited anticipation<sup>*</sup></li><li>Correct specification of \\(Y(0)\\)</li></ul>",
  "Callaway and Sant'Anna (2021) <br /> <code>{did}</code>", "2x2 Aggregation", "Either Not-yet- or Never-treated", "<ul><li>Parallel Trends for Not-yet-treated <i>or</i> Never-treated</li><li>Limited anticipation<sup>*</sup></li></ul>",
  "Sun and Abraham (2020) <br /> <code>{fixest/sunab}</code>", "2x2 Aggregation", "Not-yet- and/or Never-treated", "<ul><li>Parallel Trends for all units</li><li>Limited anticipation<sup>*</sup></li></ul>",
  "Roth and Sant'Anna (2021) <br /> <code>{staggered}</code>", "2x2 Aggregation", "Not-yet-treated", "<ul><li>Treatment timing is random</li><li>Limited anticipation<sup>*</sup></ul>",
) |> 
  dplyr::mutate(`Main Assumptions` = purrr::map(`Main Assumptions`, gt::html))

gt::gt(methods, caption="Event Study Estimators") |>
  gt::cols_align(
    align = "left",
    columns = c(`Main Assumptions`)
  ) |> 
  gt::tab_options(
  	table.font.size = 16,
    data_row.padding = gt::px(10),
    table.width = gt::px(1000),
    source_notes.font.size = gt::px(14)
  ) |>
  gt::fmt_markdown(
  	columns = c(`Main Assumptions`, `Estimator and R package`)
  ) |>
  gt::tab_source_note(
    source_note = gt::html("This table summarizes the differences between various proposed event-study estimators in the econometric literature. It highlights the two different strategies that different estimators use, namely imputation and 2x2 aggregation. Importantly, it tries to show the differences in assumptions for each different estimator.<br/><sup>*</sup> Anticipation can be accoufnted for by adjusting 'initial treatment day' back \\(x\\) periods, where \\(x\\) is the number of periods before treatment that anticipation can occur.")
  )


## ----estimators-latex---------------------------------------------------------
cat(r"(
\begin{landscape}
\begin{table}
\caption{Event Study Estimators \label{tab:estimators-latex}}
\begin{threeparttable}

\begin{tabular}{L{0.2\textwidth}L{0.2\textwidth}L{0.3\textwidth}p{0.5\textwidth}c}
\toprule
\multicolumn{1}{l}{Estimator and} & \multicolumn{1}{l}{Type} & \multicolumn{1}{l}{Comparison group} & \multicolumn{1}{c}{Main Assumptions} \\
\multicolumn{1}{l}{\texttt{R} package} & & &\\

\midrule
Gardner (2021) 
\{\texttt{did2s}\}
& Imputes $Y(0)$ 
& Not-yet- and/or Never-treated 
& 
\vspace{-5mm}
\begin{itemize}[leftmargin=*]
  \item Parallel Trends for all units
  \item Limited anticipation${^*}$
  \item Correct specification of $Y(0)$
\end{itemize}
& \\

Borusyak, Jaravel, and Spiess (2021) 
\{\texttt{didimputation}\}
& Imputes $Y(0)$ 
& Not-yet- and/or Never-treated 
& 
\vspace{-5mm}
\begin{itemize}[leftmargin=*]
  \item Parallel Trends for all units
  \item Limited anticipation${^*}$
  \item Correct specification of $Y(0)$
\end{itemize}
& \\

Callaway and Sant'Anna (2021) 
\{\texttt{did}\}
& 2$\times$2 Aggregation 
& Either Not-yet- or Never-treated 
& 
\vspace{-5mm}
\begin{itemize}[leftmargin=*]
  \item Parallel Trends for Not-yet-treated {\it or} Never-treated
  \item Limited anticipation${^*}$
\end{itemize}
& \\

Sun and Abraham (2020) 
\{\texttt{fixest}/\texttt{sunab}\}
& 2$\times$2 Aggregation 
& Not-yet- and/or Never-treated 
& 
\vspace{-5mm}
\begin{itemize}[leftmargin=*]
  \item Parallel Trends for all units
  \item Limited anticipation${^*}$
\end{itemize}
& \\

Roth and Sant'Anna (2021) 
\{\texttt{staggered}\}
& 2$\times$2 Aggregation 
& Not-yet-treated 
& 
\vspace{-5mm}
\begin{itemize}[leftmargin=*]
  \item Treatment timing is random
  \item Limited anticipation${^*}$
\end{itemize}
& \\
\bottomrule
\end{tabular}

\begin{tablenotes}
\item { This table summarizes the differences between various proposed event-study estimators in the econometric literature. It highlights the two different strategies that different estimators use, namely imputation and 2x2 aggregation. Importantly, it tries to show the differences in assumptions for each different estimator.}
\item[$^{*}$] { Anticipation can be accounted for by adjusting 'initial treatment day' back $x$ periods, where $x$ is the number of periods before treatment that anticipation can occur.}
\end{tablenotes}

\end{threeparttable}
\end{table}
\end{landscape}
)")


## ----es-estimate--------------------------------------------------------------
data(df_het, package = "did2s")
out = event_study(
  data = df_het, yname = "dep_var", idname = "unit",
  tname = "year", gname = "g", estimator = "all"
)


## ----es-estimate-head---------------------------------------------------------
head(out)


## ----es-alternatives----------------------------------------------------------
plot_event_study(out, horizon = c(-5, 10))

